# å¤©æ°”å°ç»„ä»¶è®¾è®¡æ–‡æ¡£

## ğŸ“± åŠŸèƒ½æ¦‚è¿°

å¤©æ°”å°ç»„ä»¶æ˜¯ä¸€ä¸ªæ¡Œé¢Widgetï¼Œå¯ä»¥åœ¨æ‰‹æœºæ¡Œé¢ç›´æ¥æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯ï¼Œæ— éœ€æ‰“å¼€åº”ç”¨å³å¯æŸ¥çœ‹å¤©æ°”ã€‚

## ğŸ¨ UIè®¾è®¡

### å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10æœˆ07æ—¥  å‘¨äºŒ          å†œå†ä¹æœˆåˆäº”  â”‚  â† ç¬¬ä¸€è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 20:30  â˜€ æ™´                      17Â°  â”‚  â† ç¬¬äºŒè¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“æœé˜³åŒº ğŸ’¨è‰¯38 ğŸŒ¬ï¸ä¸œå—2çº§ ğŸ’§ä»Šæ—¥æ— é›¨  â”‚  â† ç¬¬ä¸‰è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»Šå¤©  æ˜å¤©  10/09  10/10  10/11      â”‚  â† ç¬¬å››è¡Œ
â”‚  â˜€    â˜    ğŸŒ§    â›…    â˜€           â”‚
â”‚ 20Â°   18Â°   15Â°    16Â°    19Â°         â”‚
â”‚ 10Â°   12Â°   10Â°    11Â°    13Â°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†è¯´æ˜

#### ç¬¬ä¸€è¡Œï¼šæ—¥æœŸä¿¡æ¯
- **å·¦ä¾§**ï¼šå…¬å†æ—¥æœŸï¼ˆ10æœˆ07æ—¥ï¼‰
- **ä¸­é—´**ï¼šæ˜ŸæœŸå‡ ï¼ˆå‘¨äºŒï¼‰
- **å³ä¾§**ï¼šå†œå†æ—¥æœŸï¼ˆå†œå†ä¹æœˆåˆäº”ï¼‰

#### ç¬¬äºŒè¡Œï¼šæ ¸å¿ƒå¤©æ°”ä¿¡æ¯
- **å·¦ä¾§**ï¼šå½“å‰æ—¶é—´ï¼ˆ20:30ï¼‰
- **ä¸­é—´**ï¼šå¤©æ°”å›¾æ ‡ + å¤©æ°”çŠ¶æ€æ–‡å­—ï¼ˆâ˜€ æ™´ï¼‰
- **å³ä¾§**ï¼šå½“å‰æ¸©åº¦ï¼ˆ17Â°ï¼‰

#### ç¬¬ä¸‰è¡Œï¼šè¯¦ç»†ä¿¡æ¯
- **ä½ç½®**ï¼šğŸ“ å½“å‰ä½ç½®ï¼ˆæœé˜³åŒºï¼‰
- **ç©ºæ°”**ï¼šğŸ’¨ ç©ºæ°”è´¨é‡æŒ‡æ•°ï¼ˆè‰¯38ï¼‰
- **é£åŠ›**ï¼šğŸŒ¬ï¸ é£å‘é£åŠ›ï¼ˆä¸œå—2çº§ï¼‰
- **é™é›¨**ï¼šğŸ’§ é™é›¨æé†’ï¼ˆä»Šæ—¥æ— é›¨/ä»Šæ—¥æœ‰é›¨ 80% å¸¦ä¼ï¼‰

#### ç¬¬å››è¡Œï¼š5æ—¥å¤©æ°”é¢„æŠ¥
æ¯ä¸ªé¢„æŠ¥é¡¹åŒ…å«ï¼š
- æ—¥æœŸï¼ˆä»Šå¤©/æ˜å¤©/æ—¥æœŸï¼‰
- æ˜ŸæœŸï¼ˆé™¤ä»Šå¤©æ˜å¤©å¤–ï¼‰
- å¤©æ°”å›¾æ ‡
- æœ€é«˜æ¸©åº¦
- æœ€ä½æ¸©åº¦

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### 1. æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ widgets/
â”‚   â”œâ”€â”€ weather_widget_config.dart      # å°ç»„ä»¶é…ç½®
â”‚   â””â”€â”€ weather_widget_preview.dart     # å°ç»„ä»¶é¢„è§ˆï¼ˆåº”ç”¨å†…ï¼‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ weather_widget_service.dart     # å°ç»„ä»¶æœåŠ¡
â””â”€â”€ utils/
    â””â”€â”€ lunar_calendar.dart             # å†œå†è®¡ç®—å·¥å…·
```

### 2. æ ¸å¿ƒç±»è¯´æ˜

#### WeatherWidgetConfig
- å®šä¹‰å°ç»„ä»¶çš„é…ç½®å‚æ•°
- å°ºå¯¸ã€é¢œè‰²ã€å­—ä½“å¤§å°ç­‰
- æ•°æ®é”®å®šä¹‰

#### LunarCalendar
- å†œå†è®¡ç®—å·¥å…·ç±»
- æ”¯æŒ1900-2100å¹´å†œå†è½¬æ¢
- æä¾›å¤©å¹²åœ°æ”¯ã€ç”Ÿè‚–ã€å†œå†æœˆæ—¥

#### WeatherWidgetService
- å°ç»„ä»¶æ•°æ®æ›´æ–°æœåŠ¡
- æ ¼å¼åŒ–å¤©æ°”æ•°æ®
- ä¸åŸç”ŸWidgeté€šä¿¡

#### WeatherWidgetPreview
- åº”ç”¨å†…é¢„è§ˆå°ç»„ä»¶
- ç”¨äºè°ƒè¯•å’Œå±•ç¤º

### 3. æ•°æ®æµ

```
WeatherProvider (å¤©æ°”æ•°æ®)
        â†“
WeatherWidgetService (æ ¼å¼åŒ–)
        â†“
åŸç”ŸWidgetå¹³å° (Android/iOS)
        â†“
æ¡Œé¢æ˜¾ç¤º
```

## ğŸ“¦ é›†æˆæ­¥éª¤

### 1. æ·»åŠ ä¾èµ–

åœ¨ `pubspec.yaml` ä¸­æ·»åŠ ï¼š

```yaml
dependencies:
  home_widget: ^0.5.0  # æ¡Œé¢å°ç»„ä»¶æ”¯æŒ
```

### 2. Androidé…ç½®

#### 2.1 åˆ›å»ºWidgetå¸ƒå±€

`android/app/src/main/res/layout/weather_widget.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp"
    android:background="@drawable/widget_background">

    <!-- ç¬¬ä¸€è¡Œï¼šæ—¥æœŸä¿¡æ¯ -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">
        
        <TextView
            android:id="@+id/text_date"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="14sp"
            android:textColor="#333333" />
        
        <TextView
            android:id="@+id/text_weekday"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:textSize="14sp"
            android:textColor="#666666" />
        
        <View
            android:layout_width="0dp"
            android:layout_height="1dp"
            android:layout_weight="1" />
        
        <TextView
            android:id="@+id/text_lunar"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="14sp"
            android:textColor="#999999" />
    </LinearLayout>

    <!-- ç¬¬äºŒè¡Œï¼šå¤©æ°”ä¿¡æ¯ -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"
        android:orientation="horizontal"
        android:gravity="center_vertical">
        
        <TextView
            android:id="@+id/text_time"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="18sp"
            android:textColor="#666666" />
        
        <ImageView
            android:id="@+id/icon_weather"
            android:layout_width="32dp"
            android:layout_height="32dp"
            android:layout_marginStart="16dp" />
        
        <TextView
            android:id="@+id/text_weather"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="8dp"
            android:textSize="16sp"
            android:textColor="#333333" />
        
        <View
            android:layout_width="0dp"
            android:layout_height="1dp"
            android:layout_weight="1" />
        
        <TextView
            android:id="@+id/text_temperature"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="36sp"
            android:textColor="#333333"
            android:textStyle="bold" />
    </LinearLayout>

    <!-- ç¬¬ä¸‰è¡Œï¼šè¯¦ç»†ä¿¡æ¯ -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"
        android:orientation="horizontal">
        
        <TextView
            android:id="@+id/text_location"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:textSize="12sp"
            android:textColor="#666666"
            android:drawableStart="@android:drawable/ic_menu_mylocation"
            android:drawablePadding="4dp" />
        
        <TextView
            android:id="@+id/text_aqi"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="16dp"
            android:textSize="12sp"
            android:textColor="#666666" />
        
        <TextView
            android:id="@+id/text_wind"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="16dp"
            android:textSize="12sp"
            android:textColor="#666666" />
        
        <TextView
            android:id="@+id/text_rain"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="16dp"
            android:textSize="12sp"
            android:textColor="#666666" />
    </LinearLayout>

    <!-- ç¬¬å››è¡Œï¼š5æ—¥é¢„æŠ¥ -->
    <LinearLayout
        android:id="@+id/layout_forecast"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:layout_marginTop="12dp"
        android:orientation="horizontal"
        android:gravity="center" />

</LinearLayout>
```

#### 2.2 åˆ›å»ºWidget Provider

`android/app/src/main/kotlin/.../WeatherWidgetProvider.kt`:

```kotlin
class WeatherWidgetProvider : AppWidgetProvider() {
    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        for (appWidgetId in appWidgetIds) {
            updateAppWidget(context, appWidgetManager, appWidgetId)
        }
    }
    
    private fun updateAppWidget(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetId: Int
    ) {
        val views = RemoteViews(context.packageName, R.layout.weather_widget)
        
        // ä»SharedPreferencesè¯»å–æ•°æ®
        val prefs = context.getSharedPreferences("HomeWidgetPreferences", Context.MODE_PRIVATE)
        val widgetData = prefs.getString("widget_data", "")
        
        if (widgetData != null && widgetData.isNotEmpty()) {
            val json = JSONObject(widgetData)
            
            // æ›´æ–°UI
            views.setTextViewText(R.id.text_date, json.optString("date"))
            views.setTextViewText(R.id.text_weekday, json.optString("weekday"))
            views.setTextViewText(R.id.text_lunar, json.optString("lunar_date"))
            views.setTextViewText(R.id.text_time, json.optString("time"))
            views.setTextViewText(R.id.text_weather, json.optString("weather_text"))
            views.setTextViewText(R.id.text_temperature, json.optString("temperature"))
            views.setTextViewText(R.id.text_location, json.optString("location"))
            views.setTextViewText(R.id.text_aqi, json.optString("aqi"))
            views.setTextViewText(R.id.text_wind, json.optString("wind"))
            views.setTextViewText(R.id.text_rain, json.optString("rain_alert"))
        }
        
        // ç‚¹å‡»æ‰“å¼€åº”ç”¨
        val intent = Intent(context, MainActivity::class.java)
        val pendingIntent = PendingIntent.getActivity(context, 0, intent, PendingIntent.FLAG_IMMUTABLE)
        views.setOnClickPendingIntent(R.id.root_layout, pendingIntent)
        
        appWidgetManager.updateAppWidget(appWidgetId, views)
    }
}
```

#### 2.3 æ³¨å†ŒWidget

`android/app/src/main/AndroidManifest.xml`:

```xml
<receiver
    android:name=".WeatherWidgetProvider"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/weather_widget_info" />
</receiver>
```

### 3. åœ¨åº”ç”¨ä¸­é›†æˆ

åœ¨ `WeatherProvider` ä¸­æ·»åŠ å°ç»„ä»¶æ›´æ–°ï¼š

```dart
// lib/providers/weather_provider.dart

import '../services/weather_widget_service.dart';

class WeatherProvider with ChangeNotifier {
  final WeatherWidgetService _widgetService = WeatherWidgetService.getInstance();
  
  // åœ¨åˆ·æ–°å¤©æ°”æ•°æ®åæ›´æ–°å°ç»„ä»¶
  Future<void> refreshWeatherData() async {
    // ... ç°æœ‰ä»£ç  ...
    
    // æ›´æ–°å°ç»„ä»¶
    if (_currentWeather != null && _currentLocation != null) {
      await _widgetService.updateWidget(
        weatherData: _currentWeather!,
        location: _currentLocation!,
      );
    }
  }
}
```

### 4. åº”ç”¨å†…é¢„è§ˆ

åˆ›å»ºä¸€ä¸ªè®¾ç½®é¡µé¢æ˜¾ç¤ºå°ç»„ä»¶é¢„è§ˆï¼š

```dart
// lib/screens/widget_settings_screen.dart

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/weather_provider.dart';
import '../widgets/weather_widget_preview.dart';
import '../services/weather_widget_service.dart';

class WidgetSettingsScreen extends StatelessWidget {
  const WidgetSettingsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('æ¡Œé¢å°ç»„ä»¶'),
      ),
      body: Consumer<WeatherProvider>(
        builder: (context, provider, child) {
          if (provider.currentWeather == null || provider.currentLocation == null) {
            return const Center(child: Text('æš‚æ— å¤©æ°”æ•°æ®'));
          }
          
          // å‡†å¤‡é¢„è§ˆæ•°æ®
          final service = WeatherWidgetService.getInstance();
          final widgetData = service._prepareWidgetData(
            weatherData: provider.currentWeather!,
            location: provider.currentLocation!,
            now: DateTime.now(),
          );
          
          return SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Column(
              children: [
                const Text(
                  'å°ç»„ä»¶é¢„è§ˆ',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 16),
                WeatherWidgetPreview(data: widgetData),
                const SizedBox(height: 24),
                ElevatedButton(
                  onPressed: () async {
                    await service.updateWidget(
                      weatherData: provider.currentWeather!,
                      location: provider.currentLocation!,
                    );
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text('å°ç»„ä»¶å·²æ›´æ–°')),
                    );
                  },
                  child: const Text('ç«‹å³æ›´æ–°å°ç»„ä»¶'),
                ),
                const SizedBox(height: 16),
                const Text(
                  'ä½¿ç”¨è¯´æ˜ï¼š\n'
                  '1. é•¿æŒ‰æ¡Œé¢ç©ºç™½å¤„\n'
                  '2. é€‰æ‹©"å°ç»„ä»¶"\n'
                  '3. æ‰¾åˆ°"çŸ¥é›¨å¤©æ°”"å°ç»„ä»¶\n'
                  '4. æ‹–æ‹½åˆ°æ¡Œé¢',
                  style: TextStyle(color: Colors.grey),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}
```

## ğŸ¯ ç‰¹è‰²åŠŸèƒ½

1. **å†œå†æ˜¾ç¤º**ï¼šä½¿ç”¨è‡ªç ”å†œå†ç®—æ³•ï¼Œæ”¯æŒ1900-2100å¹´
2. **æ™ºèƒ½é™é›¨æé†’**ï¼šæ ¹æ®é™é›¨æ¦‚ç‡æ™ºèƒ½æç¤º
3. **5æ—¥é¢„æŠ¥**ï¼šä¸€ç›®äº†ç„¶æœªæ¥å¤©æ°”è¶‹åŠ¿
4. **å®æ—¶æ›´æ–°**ï¼šè·Ÿéšåº”ç”¨å¤©æ°”æ•°æ®è‡ªåŠ¨æ›´æ–°

## ğŸ“Š æ•°æ®æ›´æ–°æœºåˆ¶

- **è‡ªåŠ¨æ›´æ–°**ï¼šåº”ç”¨åˆ·æ–°å¤©æ°”æ—¶è‡ªåŠ¨æ›´æ–°å°ç»„ä»¶
- **åå°æ›´æ–°**ï¼šå¯é…ç½®å®šæ—¶åå°åˆ·æ–°
- **ç‚¹å‡»åˆ·æ–°**ï¼šç‚¹å‡»å°ç»„ä»¶æ‰“å¼€åº”ç”¨å¹¶åˆ·æ–°

## ğŸ¨ æ ·å¼å®šåˆ¶

å¯åœ¨ `WeatherWidgetConfig` ä¸­è‡ªå®šä¹‰ï¼š
- å°ç»„ä»¶å°ºå¯¸
- é¢œè‰²æ–¹æ¡ˆ
- å­—ä½“å¤§å°
- å›¾æ ‡æ ·å¼

## ğŸ”„ åç»­ä¼˜åŒ–

1. æ”¯æŒå¤šç§å°ºå¯¸ï¼ˆ2x2, 4x2, 4x4ï¼‰
2. æ”¯æŒæš—è‰²ä¸»é¢˜
3. æ”¯æŒå¤šåŸå¸‚åˆ‡æ¢
4. æ”¯æŒè‡ªå®šä¹‰èƒŒæ™¯å›¾
5. æ”¯æŒé€æ˜åº¦è°ƒèŠ‚

