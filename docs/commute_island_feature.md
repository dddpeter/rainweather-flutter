# 通勤提醒灵动岛功能

## 📱 功能简介

通勤提醒灵动岛是专为安卓用户设计的实时通勤建议显示功能，类似于iOS的灵动岛效果。当用户处于通勤时段时，会在通知栏顶部显示一个持久的、精美的通勤建议卡片。

## ✨ 特性

### 核心功能
- **🏝️ 持久显示**：类似iOS灵动岛，在通知栏顶部持久显示，不会被轻易关闭
- **📍 智能时段**：仅在通勤时段（早高峰/晚高峰）自动显示
- **🎨 精美样式**：大文本样式，显示通勤建议的完整内容
- **🎯 优先级智能**：自动显示最重要的通勤建议
- **🔔 无打扰**：不播放声音，不震动，不干扰用户
- **⚡ 快速操作**：提供"查看详情"和"知道了"两个快捷按钮

### 视觉设计
- **颜色编码**：根据建议级别显示不同颜色
  - 🔴 严重（Critical）：红色
  - 🟠 警告（Warning）：橙色
  - 🟢 提示（Info）：亮绿色
  - 🌿 建议（Normal）：薄荷灰绿
- **图标显示**：使用emoji图标直观展示建议类型
- **信息层次**：标题 + 内容 + 汇总信息，层次清晰

## 🎯 使用场景

### 自动显示时机
1. **通勤时段开始**
   - 早高峰：默认 7:00-9:00（可在设置中自定义）
   - 晚高峰：默认 17:30-19:30（可在设置中自定义）

2. **有新的通勤建议生成**
   - 天气条件变化时
   - AI生成新建议时
   - 手动刷新天气后

### 自动隐藏时机
1. **通勤时段结束**
   - 早高峰/晚高峰结束后自动关闭
   - 5分钟定时检查，自动清理过期建议

2. **用户主动关闭**
   - 点击"知道了"按钮
   - 手动取消通知

## 📊 显示内容

### 通知标题
```
[时段名称]通勤建议
例如: 早高峰通勤建议
```

### 通知副标题
```
[emoji] [建议标题]
例如: 🌧️ 暴雨预警
```

### 通知内容
```
[完整的通勤建议内容]
例如: 今晚将有暴雨，建议提前下班。路面积水严重，请注意绕行低洼地段...
```

### 通知汇总
```
知雨天气 · [建议数量]条通勤建议
例如: 知雨天气 · 2条通勤建议
```

## 🔧 技术实现

### 核心类
- `NotificationService` - 通知服务类
  - `showCommuteIslandNotification()` - 显示灵动岛
  - `updateCommuteIslandNotification()` - 更新灵动岛
  - `hideCommuteIslandNotification()` - 隐藏灵动岛

### 关键参数
```dart
AndroidNotificationDetails(
  'commute_island',              // 渠道ID
  '通勤提醒灵动岛',              // 渠道名称
  ongoing: true,                 // 持久显示
  autoCancel: false,             // 点击不自动关闭
  importance: Importance.high,   // 高优先级
  priority: Priority.high,       // 高优先级
  category: AndroidNotificationCategory.status,
  visibility: NotificationVisibility.public,
)
```

### 通知ID
- 固定ID: `999999`
- 使用固定ID确保同一时间只显示一个灵动岛通知
- 更新时会自动替换旧通知

### 操作按钮
1. **查看详情** (`view_details`)
   - 点击后跳转到综合提醒页面
   - 显示所有天气提醒和通勤建议的详细信息

2. **知道了** (`dismiss`)
   - 点击后关闭灵动岛通知
   - 不跳转页面

## 🔄 自动管理

### 生命周期
```
通勤时段开始
    ↓
生成通勤建议
    ↓
显示灵动岛
    ↓
[持久显示]
    ↓
建议更新 → 更新灵动岛
    ↓
时段结束 / 用户关闭
    ↓
隐藏灵动岛
```

### 数据流
```
WeatherProvider.checkAndGenerateCommuteAdvices()
    ↓
WeatherProvider.loadCommuteAdvices()
    ↓
NotificationService.showCommuteIslandNotification()
    ↓
[显示在通知栏]
```

## ⚙️ 用户设置

### 启用/禁用
- 在"天气提醒设置"中控制
- 开关：`启用通勤提醒`
- 禁用后不会显示灵动岛

### 通勤时间自定义
- 早高峰时间：可自定义开始和结束时间
- 晚高峰时间：可自定义开始和结束时间
- 工作日选择：选择哪些日期启用通勤提醒

## 🎨 用户体验

### 优点
✅ **不打扰**：无声音、无震动、无弹窗
✅ **持久性**：不会被系统自动清理
✅ **可见性**：始终显示在通知栏顶部
✅ **快捷操作**：一键查看详情或关闭
✅ **智能化**：根据通勤时段自动显示/隐藏
✅ **美观性**：颜色编码、图标展示，一目了然

### 注意事项
⚠️ **仅安卓平台**：iOS使用系统的实时活动功能
⚠️ **需要通知权限**：首次使用需授予通知权限
⚠️ **通勤时段限制**：仅在设定的通勤时段显示
⚠️ **单一显示**：同一时间只显示一个灵动岛

## 📱 平台差异

### 安卓
- ✅ 使用前台通知实现
- ✅ 支持自定义样式和操作按钮
- ✅ 持久显示在通知栏顶部
- ✅ 完整实现所有功能

### iOS
- ⏳ 未来将使用Live Activity实现
- ⏳ 计划使用灵动岛原生API
- ⏳ 更深度的系统集成

## 🔍 调试信息

### 日志输出
```dart
// 显示灵动岛
🏝️ NotificationService: 通勤灵动岛已显示 - 早高峰, 级别: 严重

// 更新灵动岛
🏝️ 灵动岛已更新（2条建议）

// 隐藏灵动岛
🏝️ NotificationService: 通勤灵动岛已隐藏
```

### 错误处理
- 所有操作都包含try-catch
- 失败时输出详细错误日志
- 不会影响应用主流程

## 📝 版本历史

### v1.12.3 (2025-01-14)
- 🎉 首次发布通勤提醒灵动岛功能
- 🏝️ 支持安卓平台持久通知显示
- 🎨 精美的视觉设计和交互体验
- ⚡ 智能的自动显示/隐藏逻辑

## 🚀 未来计划

- [ ] iOS平台支持（使用Live Activity）
- [ ] 更多自定义样式选项
- [ ] 灵动岛内容可配置
- [ ] 支持手势操作（展开/收起）
- [ ] 集成更多快捷操作
- [ ] 支持小组件联动

## 🤝 反馈

如果您对灵动岛功能有任何建议或遇到问题，欢迎反馈！

