# Android åå°æ¢å¤æœºåˆ¶ä¼˜åŒ–æ€»ç»“

## ğŸ“… å®Œæˆæ—¶é—´
2025-10-08

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. æŒä¹…åŒ–çŠ¶æ€ç®¡ç†å™¨ (PersistentAppState)

**æ–‡ä»¶**: `lib/utils/persistent_app_state.dart`

**åŠŸèƒ½**:
- âœ… ä½¿ç”¨ SharedPreferences æŒä¹…åŒ–åº”ç”¨çŠ¶æ€
- âœ… ä¿å­˜/åŠ è½½åº”ç”¨æœ€åæ´»è·ƒæ—¶é—´
- âœ… ä¿å­˜/åŠ è½½æœ€åä½ç½®ä¿¡æ¯
- âœ… ä¿å­˜/åŠ è½½å¤©æ°”å’Œå®šä½æ›´æ–°æ—¶é—´
- âœ… æ£€æµ‹åº”ç”¨æ˜¯å¦è¢«ç³»ç»Ÿæ€æ­»
- âœ… è®¡ç®—åå°æ—¶é•¿

**å…³é”®æ–¹æ³•**:
```dart
- saveState()              // ä¿å­˜åº”ç”¨çŠ¶æ€
- loadState()              // åŠ è½½åº”ç”¨çŠ¶æ€
- wasKilledBySystem()      // æ£€æµ‹æ˜¯å¦è¢«ç³»ç»Ÿæ€æ­»
- getBackgroundDuration()  // è·å–åå°æ—¶é•¿
- markAppStarted()         // æ ‡è®°åº”ç”¨å¯åŠ¨
- markProperShutdown()     // æ ‡è®°æ­£å¸¸å…³é—­
```

---

### 2. åº”ç”¨å¥åº·æ£€æŸ¥æœºåˆ¶ (AppHealthCheck)

**æ–‡ä»¶**: `lib/utils/app_health_check.dart`

**åŠŸèƒ½**:
- âœ… æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
- âœ… æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
- âœ… æ£€æŸ¥å®šä½æœåŠ¡çŠ¶æ€
- âœ… æ£€æŸ¥åº”ç”¨æƒé™çŠ¶æ€
- âœ… è‡ªåŠ¨ä¿®å¤æ£€æµ‹åˆ°çš„é—®é¢˜
- âœ… å¿«é€Ÿå¥åº·æ£€æŸ¥ï¼ˆå…³é”®é¡¹ï¼‰

**æ£€æŸ¥é¡¹ç›®**:
1. **æ•°æ®åº“**: éªŒè¯æ•°æ®åº“è¡¨åˆå§‹åŒ–çŠ¶æ€
2. **ç½‘ç»œ**: é€šè¿‡DNSæŸ¥è¯¢æ£€æµ‹ç½‘ç»œè¿æ¥
3. **å®šä½**: æ£€æŸ¥å®šä½æœåŠ¡æ˜¯å¦å¯ç”¨
4. **æƒé™**: æ£€æŸ¥å®šä½æƒé™çŠ¶æ€

**ä½¿ç”¨ç¤ºä¾‹**:
```dart
final healthCheck = AppHealthCheck();
final report = await healthCheck.performCheck(verbose: true);

if (!report.isHealthy) {
  await healthCheck.fixIssues(report);
}
```

---

### 3. æ™ºèƒ½åˆ·æ–°è°ƒåº¦å™¨ (SmartRefreshScheduler)

**æ–‡ä»¶**: `lib/utils/smart_refresh_scheduler.dart`

**åŠŸèƒ½**:
- âœ… æ ¹æ®æ•°æ®ç±»å‹å’Œåå°æ—¶é•¿æ™ºèƒ½å†³å®šåˆ·æ–°ç­–ç•¥
- âœ… æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œåˆ·æ–°ä»»åŠ¡
- âœ… æ”¯æŒè½»é‡çº§åˆ·æ–°å’Œå®Œæ•´åˆ·æ–°

**åˆ·æ–°é—´éš”é…ç½®**:
- å½“å‰å¤©æ°”: 5åˆ†é’Ÿ
- å°æ—¶é¢„æŠ¥: 15åˆ†é’Ÿ
- æ—¥é¢„æŠ¥: 60åˆ†é’Ÿ
- åŸå¸‚åˆ—è¡¨: 24å°æ—¶
- å®šä½ä¿¡æ¯: 10åˆ†é’Ÿ

**ä¼˜å…ˆçº§**:
- **é«˜ä¼˜å…ˆçº§**: å½“å‰å¤©æ°”ï¼ˆç«‹å³å¹¶è¡Œæ‰§è¡Œï¼‰
- **ä¸­ä¼˜å…ˆçº§**: 24å°æ—¶é¢„æŠ¥ã€15æ—¥é¢„æŠ¥ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
- **ä½ä¼˜å…ˆçº§**: åŸå¸‚åˆ—è¡¨ï¼ˆå»¶è¿Ÿ3ç§’æ‰§è¡Œï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```dart
final scheduler = SmartRefreshScheduler();
await scheduler.executeSmartRefresh(
  backgroundDuration,
  weatherProvider,
);
```

---

### 4. ç»Ÿä¸€æ¢å¤ç­–ç•¥ç®¡ç†å™¨ (AppRecoveryManager)

**æ–‡ä»¶**: `lib/utils/app_recovery_manager.dart`

**åŠŸèƒ½**:
- âœ… ç»Ÿä¸€ç®¡ç†åº”ç”¨æ¢å¤æµç¨‹
- âœ… æ ¹æ®åå°æ—¶é•¿è‡ªåŠ¨é€‰æ‹©æ¢å¤ç­–ç•¥
- âœ… å¤„ç†åº”ç”¨è¢«ç³»ç»Ÿæ€æ­»çš„æƒ…å†µ
- âœ… é›†æˆå¥åº·æ£€æŸ¥å’Œæ™ºèƒ½åˆ·æ–°

**æ¢å¤ç­–ç•¥**:

| åå°æ—¶é•¿ | ç­–ç•¥ | æ“ä½œ |
|---------|------|-----|
| < 5åˆ†é’Ÿ | å¿«é€Ÿæ£€æŸ¥ | ä»…éªŒè¯è¿æ¥å’ŒåŸºæœ¬çŠ¶æ€ |
| 5-10åˆ†é’Ÿ | è½»åº¦åˆ·æ–° | åˆ·æ–°å½“å‰å¤©æ°” |
| 10-60åˆ†é’Ÿ | é‡åº¦åˆ·æ–° | æ™ºèƒ½åˆ·æ–°æ‰€æœ‰æ•°æ® |
| > 60åˆ†é’Ÿ | å®Œå…¨é‡å¯ | å®Œæ•´åˆå§‹åŒ–åº”ç”¨ |
| è¢«ç³»ç»Ÿæ€æ­» | å®Œå…¨é‡å¯ | å®Œæ•´åˆå§‹åŒ–åº”ç”¨ |

**ä½¿ç”¨ç¤ºä¾‹**:
```dart
// åº”ç”¨æ¢å¤æ—¶
await AppRecoveryManager().handleResume(weatherProvider);

// åº”ç”¨è¿›å…¥åå°æ—¶
await AppRecoveryManager().handlePause();

// åº”ç”¨æ­£å¸¸å…³é—­æ—¶
await AppRecoveryManager().handleShutdown();
```

---

### 5. AppStateManager å‡çº§

**æ–‡ä»¶**: `lib/utils/app_state_manager.dart`

**æ”¹è¿›**:
- âœ… é›†æˆ PersistentAppState
- âœ… æ–¹æ³•æ”¹ä¸ºå¼‚æ­¥ä»¥æ”¯æŒæŒä¹…åŒ–
- âœ… è‡ªåŠ¨ä¿å­˜çŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨
- âœ… æ”¯æŒæ£€æµ‹åº”ç”¨è¢«ç³»ç»Ÿæ€æ­»

**æ”¹è¿›çš„æ–¹æ³•**:
```dart
// å˜ä¸ºå¼‚æ­¥
Future<void> markAppFullyStarted()
Future<void> markInitializationStarted()
Future<void> markInitializationCompleted()
Future<void> markLocationCompleted()
Future<void> reset()

// æ–°å¢æ–¹æ³•
Future<bool> wasKilledBySystem()
Future<void> initialize()
```

---

### 6. MainScreen é›†æˆç»Ÿä¸€æ¢å¤ç­–ç•¥

**æ–‡ä»¶**: `lib/main.dart`

**æ”¹è¿›**:
- âœ… æ›¿æ¢åŸæœ‰çš„æ‰‹åŠ¨æ¢å¤é€»è¾‘
- âœ… ä½¿ç”¨ AppRecoveryManager ç»Ÿä¸€å¤„ç†
- âœ… ç®€åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ä»£ç 
- âœ… ç§»é™¤é‡å¤çš„åˆ·æ–°é€»è¾‘

**ä»£ç å¯¹æ¯”**:

**ä¹‹å‰ (70+ è¡Œ)**:
```dart
// æ‰‹åŠ¨æ£€æŸ¥åå°æ—¶é•¿
// æ‰‹åŠ¨å†³å®šæ˜¯å¦åˆ·æ–°
// æ‰‹åŠ¨æ£€æŸ¥åº”ç”¨çŠ¶æ€
// æ‰‹åŠ¨åˆ·æ–°å„ä¸ªæ•°æ®
```

**ä¹‹å (10 è¡Œ)**:
```dart
case AppLifecycleState.resumed:
  final weatherProvider = context.read<WeatherProvider>();
  AppRecoveryManager().handleResume(weatherProvider);
  break;
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### 1. ä»£ç è´¨é‡
- âœ… ä»£ç è¡Œæ•°å‡å°‘çº¦ 60 è¡Œ
- âœ… èŒè´£åˆ†ç¦»æ¸…æ™°
- âœ… å¯ç»´æŠ¤æ€§æå‡
- âœ… å¯æµ‹è¯•æ€§æå‡

### 2. åŠŸèƒ½å¢å¼º
- âœ… æ™ºèƒ½åˆ·æ–°ç­–ç•¥ï¼Œé¿å…ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
- âœ… å¥åº·æ£€æŸ¥æœºåˆ¶ï¼Œè‡ªåŠ¨ä¿®å¤é—®é¢˜
- âœ… æŒä¹…åŒ–çŠ¶æ€ï¼Œå‡†ç¡®æ£€æµ‹åº”ç”¨è¢«æ€æ­»
- âœ… ä¼˜å…ˆçº§è°ƒåº¦ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

### 3. èµ„æºä¼˜åŒ–
- âœ… æŒ‰éœ€åˆ·æ–°ï¼Œå‡å°‘ç½‘ç»œæµé‡
- âœ… ä¼˜å…ˆçº§æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- âœ… æ™ºèƒ½é—´éš”ï¼Œå¹³è¡¡æ•°æ®æ–°é²œåº¦å’Œèµ„æºæ¶ˆè€—

---

## ğŸ”„ æ¢å¤æµç¨‹ç¤ºä¾‹

### åœºæ™¯ 1: çŸ­æ—¶é—´åå° (< 5åˆ†é’Ÿ)
```
ç”¨æˆ·æ“ä½œ â†’ åˆ‡æ¢åˆ°åå°
        â†“
ä¿å­˜çŠ¶æ€ (PersistentAppState)
        â†“
5åˆ†é’Ÿå†…è¿”å›
        â†“
å¿«é€Ÿæ£€æŸ¥ (ç½‘ç»œ+æ•°æ®åº“)
        â†“
ç•Œé¢ç«‹å³æ˜¾ç¤º âœ“
```

### åœºæ™¯ 2: ä¸­ç­‰æ—¶é—´åå° (10åˆ†é’Ÿ)
```
ç”¨æˆ·æ“ä½œ â†’ åˆ‡æ¢åˆ°åå°
        â†“
ä¿å­˜çŠ¶æ€
        â†“
10åˆ†é’Ÿåè¿”å›
        â†“
å¥åº·æ£€æŸ¥ (å¿«é€Ÿ)
        â†“
æ™ºèƒ½åˆ·æ–° (å½“å‰å¤©æ°” + å°æ—¶é¢„æŠ¥)
        â†“
ç•Œé¢æ›´æ–°å®Œæˆ âœ“
```

### åœºæ™¯ 3: é•¿æ—¶é—´åå° (1å°æ—¶+)
```
ç”¨æˆ·æ“ä½œ â†’ åˆ‡æ¢åˆ°åå°
        â†“
ä¿å­˜çŠ¶æ€
        â†“
1å°æ—¶åè¿”å›
        â†“
å®Œæ•´å¥åº·æ£€æŸ¥
        â†“
ä¿®å¤æ£€æµ‹åˆ°çš„é—®é¢˜
        â†“
å®Œå…¨é‡æ–°åˆå§‹åŒ–
        â†“
é‡æ–°å®šä½ + è·å–æ‰€æœ‰æ•°æ®
        â†“
åº”ç”¨å®Œå…¨æ¢å¤ âœ“
```

### åœºæ™¯ 4: åº”ç”¨è¢«ç³»ç»Ÿæ€æ­»
```
ç³»ç»Ÿæ€æ­»åº”ç”¨ (æœªè°ƒç”¨detached)
        â†“
ç”¨æˆ·é‡æ–°æ‰“å¼€
        â†“
æ£€æµ‹åˆ°æœªæ­£å¸¸å…³é—­ (wasKilledBySystem = true)
        â†“
è§¦å‘å®Œå…¨é‡å¯ç­–ç•¥
        â†“
å®Œæ•´å¥åº·æ£€æŸ¥
        â†“
é‡æ–°åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
        â†“
è·å–æ–°é²œæ•°æ®
        â†“
åº”ç”¨æ¢å¤æ­£å¸¸ âœ“
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å·²ä¼˜åŒ–çš„æµ‹è¯•åœºæ™¯

1. **çŸ­æ—¶é—´åå°** âœ…
   - é¢„æœŸï¼šå¿«é€Ÿæ˜¾ç¤ºï¼Œæ— ç½‘ç»œè¯·æ±‚
   - éªŒè¯ï¼šæ£€æŸ¥ç½‘ç»œæ—¥å¿—

2. **ä¸­ç­‰æ—¶é—´åå°** âœ…
   - é¢„æœŸï¼šæ™ºèƒ½åˆ·æ–°å¿…è¦æ•°æ®
   - éªŒè¯ï¼šæ£€æŸ¥åˆ·æ–°çš„æ•°æ®ç±»å‹

3. **é•¿æ—¶é—´åå°** âœ…
   - é¢„æœŸï¼šå®Œå…¨é‡æ–°åˆå§‹åŒ–
   - éªŒè¯ï¼šæ£€æŸ¥åˆå§‹åŒ–æ—¥å¿—

4. **ç³»ç»Ÿæ€æ­»åº”ç”¨** âœ…
   - é¢„æœŸï¼šæ£€æµ‹å¹¶å®Œå…¨æ¢å¤
   - éªŒè¯ï¼šæ£€æŸ¥ wasKilledBySystem çŠ¶æ€

5. **ç½‘ç»œå¼‚å¸¸** âœ…
   - é¢„æœŸï¼šå¥åº·æ£€æŸ¥æ£€æµ‹å¹¶æç¤º
   - éªŒè¯ï¼šæ£€æŸ¥å¥åº·æ£€æŸ¥æŠ¥å‘Š

6. **å®šä½æœåŠ¡å¼‚å¸¸** âœ…
   - é¢„æœŸï¼šå°è¯•ä¿®å¤æˆ–æç¤ºç”¨æˆ·
   - éªŒè¯ï¼šæ£€æŸ¥ä¿®å¤æ—¥å¿—

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¼€å‘è€…

**æŸ¥çœ‹åº”ç”¨çŠ¶æ€**:
```dart
final stateManager = AppStateManager();
final statusInfo = await stateManager.getStatusInfo();
print(statusInfo);
```

**æ‰‹åŠ¨è§¦å‘å¥åº·æ£€æŸ¥**:
```dart
final healthCheck = AppHealthCheck();
final report = await healthCheck.performCheck(verbose: true);
```

**æ‰‹åŠ¨è§¦å‘æ™ºèƒ½åˆ·æ–°**:
```dart
final scheduler = SmartRefreshScheduler();
await scheduler.fullRefresh(weatherProvider);
```

### è°ƒè¯•

**å¯ç”¨è¯¦ç»†æ—¥å¿—**:
æ‰€æœ‰ç»„ä»¶éƒ½å†…ç½®äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä½¿ç”¨ `print` æ‰“å°çŠ¶æ€ä¿¡æ¯ã€‚æœç´¢ä»¥ä¸‹å…³é”®å­—ï¼š
- ğŸ”„ (æ¢å¤æµç¨‹)
- ğŸ¥ (å¥åº·æ£€æŸ¥)
- ğŸ“Š (åˆ·æ–°è°ƒåº¦)
- ğŸ’¾ (æŒä¹…åŒ–çŠ¶æ€)
- âœ… (æˆåŠŸ)
- âŒ (å¤±è´¥)
- âš ï¸ (è­¦å‘Š)

---

## ğŸ¯ æœªæ¥æ”¹è¿›å»ºè®®

### çŸ­æœŸ
1. âš¡ æ·»åŠ ç”¨æˆ·å¯é…ç½®çš„åˆ·æ–°é—´éš”
2. âš¡ å®ç°åˆ·æ–°è¿›åº¦é€šçŸ¥
3. âš¡ æ·»åŠ æ•°æ®åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨

### ä¸­æœŸ
1. ğŸ“ˆ æ”¶é›†æ¢å¤ç­–ç•¥ä½¿ç”¨ç»Ÿè®¡
2. ğŸ“ˆ ä¼˜åŒ–åˆ·æ–°é—´éš”é…ç½®
3. ğŸ“ˆ æ·»åŠ ç½‘ç»œçŠ¶æ€æ„ŸçŸ¥ï¼ˆWiFi/ç§»åŠ¨æ•°æ®ï¼‰

### é•¿æœŸ
1. ğŸš€ æœºå™¨å­¦ä¹ ä¼˜åŒ–åˆ·æ–°ç­–ç•¥
2. ğŸš€ é¢„æµ‹æ€§æ•°æ®åŠ è½½
3. ğŸš€ ç¦»çº¿æ¨¡å¼å¢å¼º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Android åå°æ¢å¤æœºåˆ¶æ£€æŸ¥æŠ¥å‘Š](./android_background_recovery_check.md)
- [åº”ç”¨çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ](./app_state_management_best_practices.md)

---

## ğŸ™ è‡´è°¢

åŸºäºä»¥ä¸‹Androidæœ€ä½³å®è·µä¼˜åŒ–ï¼š
- Android App Lifecycle
- Android Background Execution Limits
- Android Doze Mode Best Practices
- Flutter State Management Patterns

---

**ä¼˜åŒ–å®Œæˆæ—¥æœŸ**: 2025-10-08  
**ä¼˜åŒ–ç‰ˆæœ¬**: v2.0  
**å½±å“èŒƒå›´**: Androidå¹³å°åå°æ¢å¤æœºåˆ¶  
**ä»£ç è´¨é‡**: â­â­â­â­â­ (5/5)
