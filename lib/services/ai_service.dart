import 'dart:convert';
import 'package:http/http.dart' as http;

/// æ™ºè°±AIæœåŠ¡ - ç”¨äºæ™ºèƒ½é€šå‹¤å»ºè®®ç”Ÿæˆ
class AIService {
  static final AIService _instance = AIService._internal();
  factory AIService() => _instance;
  AIService._internal();

  static const String _apiKey =
      '22af66926af540978a59d67bf6806fe0.vyrFy5UXn9meHyND';
  static const String _apiUrl =
      'https://open.bigmodel.cn/api/paas/v4/chat/completions';
  static const String _model = 'glm-4-flash';

  /// è°ƒç”¨æ™ºè°±AIç”Ÿæˆæ™ºèƒ½å»ºè®®
  Future<String?> generateSmartAdvice(String prompt) async {
    print('\n========================================');
    print('ğŸ¤– AIæœåŠ¡ï¼šå¼€å§‹è°ƒç”¨æ™ºè°±AI');
    print('========================================');
    print('ğŸ“¡ APIåœ°å€: $_apiUrl');
    print('ğŸ”‘ APIå¯†é’¥: ${_apiKey.substring(0, 10)}...');
    print('ğŸ¤– ä½¿ç”¨æ¨¡å‹: $_model');
    print('----------------------------------------');
    print('ğŸ“ Promptå†…å®¹:');
    print(prompt);
    print('----------------------------------------\n');

    try {
      final requestBody = {
        'model': _model,
        'messages': [
          {'role': 'user', 'content': prompt},
        ],
      };

      print('ğŸ“¤ å‘é€è¯·æ±‚...');
      print('è¯·æ±‚ä½“: ${jsonEncode(requestBody)}');

      final response = await http
          .post(
            Uri.parse(_apiUrl),
            headers: {
              'Authorization': _apiKey,
              'Content-Type': 'application/json',
            },
            body: jsonEncode(requestBody),
          )
          .timeout(
            const Duration(seconds: 15),
            onTimeout: () {
              print('â° AIè¯·æ±‚è¶…æ—¶ï¼ˆ15ç§’ï¼‰');
              throw Exception('AIè¯·æ±‚è¶…æ—¶');
            },
          );

      print('ğŸ“¥ æ”¶åˆ°å“åº”');
      print('çŠ¶æ€ç : ${response.statusCode}');
      print('å“åº”ä½“é•¿åº¦: ${response.body.length} å­—èŠ‚');

      if (response.statusCode == 200) {
        print('âœ… HTTPè¯·æ±‚æˆåŠŸ');

        final jsonData = jsonDecode(utf8.decode(response.bodyBytes));
        print('ğŸ“Š è§£æJSONæˆåŠŸ');
        print('å®Œæ•´å“åº”: ${jsonEncode(jsonData)}');

        final choices = jsonData['choices'] as List?;
        print('Choicesæ•°é‡: ${choices?.length ?? 0}');

        if (choices != null && choices.isNotEmpty) {
          final message = choices[0]['message'] as Map<String, dynamic>?;
          final content = message?['content'] as String?;

          if (content != null && content.isNotEmpty) {
            print('\n========================================');
            print('âœ… AIå“åº”æˆåŠŸ');
            print('========================================');
            print('ğŸ’¬ å®Œæ•´å†…å®¹:');
            print(content);
            print('========================================\n');
            return content;
          } else {
            print('âš ï¸ contentä¸ºç©º');
          }
        } else {
          print('âš ï¸ choicesä¸ºç©ºæˆ–ä¸å­˜åœ¨');
        }

        print('âš ï¸ AIå“åº”æ ¼å¼å¼‚å¸¸');
        return null;
      } else {
        print('\n========================================');
        print('âŒ AIè¯·æ±‚å¤±è´¥');
        print('========================================');
        print('çŠ¶æ€ç : ${response.statusCode}');
        print('å“åº”å¤´: ${response.headers}');
        print('å“åº”ä½“: ${response.body}');
        print('========================================\n');
        return null;
      }
    } catch (e, stackTrace) {
      print('\n========================================');
      print('âŒ AIæœåŠ¡å¼‚å¸¸');
      print('========================================');
      print('é”™è¯¯ç±»å‹: ${e.runtimeType}');
      print('é”™è¯¯ä¿¡æ¯: $e');
      print('å †æ ˆè·Ÿè¸ª:');
      print(stackTrace);
      print('========================================\n');
      return null;
    }
  }

  /// æ„å»ºé€šå‹¤å»ºè®®çš„Prompt
  String buildCommutePrompt({
    required String weatherType,
    required String temperature,
    required String windPower,
    required String airQuality,
    required String timeSlot,
    required List<String> futureWeather,
  }) {
    final futureWeatherStr = futureWeather.isEmpty
        ? 'æ— é¢„æŠ¥æ•°æ®'
        : futureWeather.join('ã€');

    final greeting = timeSlot == 'morning' ? 'æ—©å®‰' : 'æ™šå®‰';
    final timeLabel = timeSlot == 'morning' ? 'æ—©é«˜å³°' : 'æ™šé«˜å³°';

    return '''ã€è§’è‰²å®šä¹‰ã€‘
ä½ æ˜¯ã€Œé€šå‹¤å¤©æ°”ç®¡å®¶ã€â€”â€”ä¸€ä½ä¸“æ³¨äºç”¨å¤©æ°”æ•°æ®å®ˆæŠ¤ä¸Šä¸‹ç­å®‰å…¨ã€èˆ’é€‚ã€æ•ˆç‡çš„ç§äººåŠ©ç†ã€‚

ã€å½“å‰æ—¶æ®µã€‘$timeLabel é€šå‹¤

ã€å¤©æ°”æ•°æ®ã€‘
- å¤©æ°”ç°è±¡ï¼š$weatherType
- æ°”æ¸©ï¼š$temperatureâ„ƒ
- é£åŠ›ï¼š$windPower
- ç©ºæ°”è´¨é‡ï¼š$airQuality
- æœªæ¥è¶‹åŠ¿ï¼š$futureWeatherStr

ã€ä¸¥æ ¼è¾“å‡ºæ ¼å¼ã€‘
âš ï¸ è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ æˆ–å‡å°‘ä»»ä½•ç©ºè¡Œï¼š

ç¬¬1è¡Œï¼š${greeting == 'æ—©å®‰' ? 'ğŸŒ' : 'ğŸŒ™'} ${greeting}ï¼ä»Šå¤©$timeLabel é€šå‹¤å¦‚ä¸‹â€”â€”
ç¬¬2è¡Œï¼šç©ºè¡Œ
ç¬¬3è¡Œå¼€å§‹ï¼šåˆ†æ®µæ¸…å•ï¼ˆæ¯è¡Œä¸€ä¸ªå»ºè®®ï¼Œæ ¹æ®å¤©æ°”é€‰æ‹©2-5é¡¹ï¼Œè¡Œä¸è¡Œä¹‹é—´ä¸åŠ ç©ºè¡Œï¼‰
  - ğŸŒ‚ é˜²é›¨ï¼š[å†…å®¹]ï¼ˆâš ï¸åªæœ‰ä¸‹é›¨æ—¶æ‰å»ºè®®å¸¦ä¼ï¼Œé›¾/éœ¾/é˜´å¤©ä¸å»ºè®®ï¼‰
  - ğŸ‘” ç€è£…ï¼š[å…·ä½“ç€è£…]ï¼ˆå¿…é¡»å…·ä½“ï¼Œå¦‚ï¼šé•¿è¢–è¡¬è¡«+è–„å¤–å¥—ã€ç¾½ç»’æœ+ä¿æš–å†…è¡£ï¼‰
  - ğŸ‘Ÿ é‹å±¥ï¼š[å†…å®¹]
  - â˜€ï¸ é˜²æ™’/é˜²å¯’ï¼š[å†…å®¹]
  - ğŸ«§ ç©ºæ°”ï¼š[å†…å®¹]
  - ğŸš¦ äº¤é€šå®‰å…¨ï¼š[å†…å®¹]
æ¸…å•æœ€åä¸€è¡Œåï¼šç©ºè¡Œ
ä¸‹ä¸€è¡Œï¼šğŸš‡ äº¤é€šæŒ‡æ•°ï¼š
ä¹‹åæ¯è¡Œï¼šä¸€ä¸ªäº¤é€šå·¥å…·åŠå…¶æ˜Ÿçº§ï¼ˆåœ°é“â­â­â­â­â­ï¼‰
äº¤é€šæŒ‡æ•°æœ€åä¸€è¡Œåï¼šç©ºè¡Œ
æœ€åä¸€è¡Œï¼šğŸ’¡ [å½©è›‹å†…å®¹]

ã€å†…å®¹è¦æ±‚ã€‘
- æ¯æ¡å»ºè®®â‰¤20å­—
- äº²åˆ‡ã€å£è¯­åŒ–
- å…ˆç»“è®ºå†ç†ç”±
- æ€»å­—æ•°150-200å­—

ã€ä¸¥æ ¼æ ¼å¼ç¤ºä¾‹ã€‘ï¼ˆè¯·å®Œå…¨æŒ‰ç…§æ­¤æ ¼å¼ï¼ŒåŒ…æ‹¬ç©ºè¡Œä½ç½®ï¼‰
ğŸŒ æ—©å®‰ï¼ä»Šå¤©æ—©é«˜å³°é€šå‹¤å¦‚ä¸‹â€”â€”
ğŸŒ‚ é˜²é›¨ï¼šé™æ°´æ¦‚ç‡ä½ï¼Œæ”¾å¿ƒçœä¼ã€‚
ğŸ‘” ç€è£…ï¼šè–„é•¿è¢–+é˜²æ™’è¡«ï¼Œèˆ’é€‚é€æ°”ã€‚
ğŸ‘Ÿ é‹å±¥ï¼šè·¯é¢å¹²ç‡¥ï¼Œå¸¸è§„è¿åŠ¨é‹ã€‚
â˜€ï¸ é˜²æ™’ï¼šç´«å¤–çº¿å¼ºï¼Œéœ²è‚¤æ¶‚SPF30+ã€‚
ğŸ«§ ç©ºæ°”ï¼šAQIä¼˜ï¼Œç•…å¿«å‘¼å¸ã€‚
ğŸš‡ äº¤é€šæŒ‡æ•°ï¼š
  åœ°é“ â­â­â­â­â­
  å…¬äº¤ â­â­â­â­
  éª‘è¡Œ â­â­â­
  è‡ªé©¾ â­â­
ğŸ’¡ ä»Šå¤©æ˜¯ä¸ªå¥½å¤©æ°”ï¼Œä¿æŒå¥½å¿ƒæƒ…ï¼

âš ï¸ ä¸¥æ ¼è¦æ±‚ï¼š
1. æ¸…å•é¡¹ä¹‹é—´ä¸åŠ ç©ºè¡Œ
2. äº¤é€šæŒ‡æ•°æ ‡é¢˜å•ç‹¬ä¸€è¡Œ
3. æ¯ä¸ªäº¤é€šå·¥å…·å•ç‹¬ä¸€è¡Œ
4. ä¸è¦åœ¨å¼€å¤´æˆ–ç»“å°¾æ·»åŠ é¢å¤–ç©ºè¡Œ

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºï¼Œç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å…¶ä»–è¯´æ˜ã€‚''';
  }

  /// è§£æAIè¿”å›çš„å»ºè®®æ–‡æœ¬
  List<String> parseAdviceText(String text) {
    // ä¿ç•™AIè¿”å›çš„åŸå§‹æ•°æ®ï¼Œåªå»æ‰é¦–å°¾ç©ºç™½
    final cleanedText = text.trim();

    // å¯¹äºæ–°ç‰ˆé€šå‹¤æé†’ï¼ˆåŒ…å«é—®å€™ã€æ¸…å•ã€æ¨èã€å½©è›‹ï¼‰ï¼Œä½œä¸ºæ•´ä½“è¿”å›
    if (cleanedText.contains('ğŸŒ') ||
        cleanedText.contains('ğŸŒ™') ||
        cleanedText.contains('æ—©å®‰') ||
        cleanedText.contains('æ™šå®‰') ||
        cleanedText.contains('ğŸš‡') ||
        cleanedText.contains('ğŸ’¡')) {
      // ç›´æ¥è¿”å›åŸå§‹æ–‡æœ¬ï¼Œä¸åšä»»ä½•æ ¼å¼åŒ–
      return [cleanedText];
    }

    // å…¼å®¹æ—§ç‰ˆæ ¼å¼ï¼šæŒ‰è¡Œæ‹†åˆ†
    final lines = cleanedText.split('\n');
    final advices = <String>[];

    for (var line in lines) {
      final trimmed = line.trim();
      if (trimmed.isEmpty) continue;

      // ç§»é™¤"å»ºè®®1ï¼š"ã€"å»ºè®®2ï¼š"ç­‰å‰ç¼€
      final cleanedLine = trimmed
          .replaceFirst(RegExp(r'^å»ºè®®\d+[ï¼š:]\s*'), '')
          .replaceFirst(RegExp(r'^[\d+\.\-\*]\s*'), '');

      if (cleanedLine.isNotEmpty) {
        advices.add(cleanedLine);
      }
    }

    return advices;
  }

  /// æ„å»ºå¤©æ°”é¢„è­¦çš„Promptï¼ˆç”¨äºå¢å¼ºæé†’å†…å®¹ï¼‰
  String buildWeatherAlertPrompt({
    required String weatherTerm,
    required String cityName,
    required String timeInfo,
    required String alertLevel,
    required bool isRequired,
  }) {
    final urgencyText = isRequired ? 'è¿™æ˜¯å¿…é¡»æé†’çš„å±é™©å¤©æ°”' : 'è¿™éœ€è¦æé†’ç”¨æˆ·æ³¨æ„';

    return '''ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ°”è±¡é¢„è­¦åŠ©æ‰‹ï¼Œè¯·ä¸ºä»¥ä¸‹å¤©æ°”æƒ…å†µç”Ÿæˆç®€æ´å®ç”¨çš„æé†’å†…å®¹ã€‚

ã€åŸå¸‚ã€‘$cityName
ã€å¤©æ°”ã€‘$weatherTerm
ã€æ—¶é—´ã€‘$timeInfo
ã€çº§åˆ«ã€‘$alertLevel
ã€é‡è¦æ€§ã€‘$urgencyText

ã€è¦æ±‚ã€‘
1. ç”Ÿæˆä¸€æ¡50å­—ä»¥å†…çš„æé†’å†…å®¹
2. é‡ç‚¹è¯´æ˜ï¼šå¤©æ°”å½±å“ã€æ³¨æ„äº‹é¡¹ã€å®ç”¨å»ºè®®
3. è¯­æ°”æ ¹æ®çº§åˆ«è°ƒæ•´ï¼ˆä¸¥é‡å¤©æ°”ç”¨ç´§æ€¥è¯­æ°”ï¼Œä¸€èˆ¬å¤©æ°”ç”¨æ¸©å’Œæé†’ï¼‰
4. ä¸è¦ä½¿ç”¨"æ‚¨å¥½"ç­‰å¯’æš„è¯­
5. ç›´æ¥è¾“å‡ºæé†’å†…å®¹ï¼Œä¸è¦æ ‡é¢˜å’Œé¢å¤–è¯´æ˜

è¯·ç›´æ¥è¾“å‡ºæé†’å†…å®¹ï¼š''';
  }

  /// æ„å»ºå¤©æ°”æ€»ç»“çš„Promptï¼ˆç”¨äºç”Ÿæˆæ™ºèƒ½å¤©æ°”æ‘˜è¦ï¼‰
  String buildWeatherSummaryPrompt({
    required String currentWeather,
    required String temperature,
    required String airQuality,
    required List<String> upcomingWeather,
    String? humidity,
    String? windPower,
  }) {
    final upcomingText = upcomingWeather.isEmpty
        ? 'æš‚æ— '
        : upcomingWeather.take(3).join('â†’');

    return '''è¯·æ ¹æ®å¤©æ°”æƒ…å†µç”Ÿæˆä¸€æ®µæ™ºèƒ½å¤©æ°”å»ºè®®ã€‚

ã€å½“å‰å¤©æ°”ã€‘
- å¤©æ°”çŠ¶å†µï¼š$currentWeather
- æ¸©åº¦ï¼š$temperatureâ„ƒ
- ç©ºæ°”è´¨é‡ï¼š$airQuality
${humidity != null ? '- æ¹¿åº¦ï¼š$humidity%' : ''}
${windPower != null ? '- é£åŠ›ï¼š$windPower' : ''}

ã€æœªæ¥è¶‹åŠ¿ã€‘æ¥ä¸‹æ¥å‡ å°æ—¶ï¼š$upcomingText

ã€ä¸¥æ ¼æ ¼å¼è¦æ±‚ã€‘
1. **å­—æ•°é™åˆ¶ï¼šä¸¥æ ¼æ§åˆ¶åœ¨80-100å­—ä¹‹é—´**
2. **æ ¼å¼è¦æ±‚ï¼šä¸€æ®µè¿è´¯çš„æ–‡å­—ï¼Œä¸åˆ†è¡Œï¼Œä¸åŠ æ¢è¡Œç¬¦**
3. å¿…é¡»åŒ…å«ä»¥ä¸‹å®ç”¨å»ºè®®ï¼š
   - æ˜¯å¦éœ€è¦å¸¦ä¼ï¼ˆæ ¹æ®å¤©æ°”å’Œæœªæ¥è¶‹åŠ¿åˆ¤æ–­ï¼‰
   - ç©¿è¡£å»ºè®®ï¼ˆæ ¹æ®æ¸©åº¦å’Œå¤©æ°”ï¼‰
   - å…¶ä»–é‡è¦æé†’ï¼ˆå¦‚ç©ºæ°”è´¨é‡ã€é˜²æ™’ç­‰ï¼‰
4. è¯­æ°”è‡ªç„¶å‹å¥½ï¼Œåƒæœ‹å‹çš„å…³å¿ƒ
5. å»ºè®®è¦å…·ä½“å®ç”¨ï¼Œä¸è¦ç©ºæ´
6. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦æ ‡é¢˜ï¼Œä¸è¦æ¢è¡Œ

ã€æ ¼å¼ç¤ºä¾‹ã€‘
ä»Šå¤©${currentWeather}ï¼Œæ°”æ¸©${temperature}â„ƒï¼Œç©ºæ°”è´¨é‡${airQuality}ã€‚å»ºè®®æºå¸¦é›¨ä¼ä»¥é˜²çªé™å°é›¨ï¼Œç©¿ç€è–„å¤–å¥—+é•¿è¢–è¡¬è¡«å³å¯ã€‚ç©ºæ°”è´¨é‡ä¼˜è‰¯ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨ï¼Œå‡ºé—¨è®°å¾—æ¶‚é˜²æ™’éœœã€‚

âš ï¸ æ³¨æ„ï¼šè¾“å‡ºå¿…é¡»æ˜¯ä¸€æ®µè¿è´¯çš„æ–‡å­—ï¼Œä¸è¦åˆ†è¡Œï¼Œä¸è¦åˆ†æ®µï¼Œä¸è¦æœ‰æ¢è¡Œç¬¦ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚è¾“å‡ºï¼š''';
  }

  /// æ„å»º15æ—¥å¤©æ°”æ€»ç»“çš„Prompt
  String buildForecast15dSummaryPrompt({
    required List<Map<String, dynamic>> dailyForecasts,
    required String cityName,
  }) {
    // æå–å…³é”®å¤©æ°”ä¿¡æ¯
    final weatherTypes = <String>{};
    final tempRanges = <String>[];

    for (var i = 0; i < dailyForecasts.length && i < 15; i++) {
      final day = dailyForecasts[i];
      weatherTypes.add(day['weather'] ?? '');
      if (day['tempMax'] != null && day['tempMin'] != null) {
        tempRanges.add('${day['tempMax']}~${day['tempMin']}â„ƒ');
      }
    }

    return '''ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ°”è±¡åˆ†æå¸ˆï¼Œè¯·ç”¨ä¸€æ®µè¯æ€»ç»“æœªæ¥15å¤©çš„å¤©æ°”è¶‹åŠ¿å’Œå»ºè®®ã€‚

ã€åŸå¸‚ã€‘$cityName
ã€å¤©æ°”ç±»å‹ã€‘${weatherTypes.join('ã€')}
ã€æ¸©åº¦èŒƒå›´ã€‘${tempRanges.take(5).join('ã€')}ç­‰

ã€è¦æ±‚ã€‘
1. 80-120å­—ä¹‹é—´
2. é‡ç‚¹è¯´æ˜ï¼šä¸»è¦å¤©æ°”ç‰¹å¾ã€æ¸©åº¦å˜åŒ–è¶‹åŠ¿ã€éœ€è¦æ³¨æ„çš„å¤©æ°”
3. æä¾›1-2æ¡å®ç”¨çš„ç”Ÿæ´»å»ºè®®ï¼ˆå¦‚ç©¿è¡£ã€å‡ºè¡Œã€æ´»åŠ¨å®‰æ’ç­‰ï¼‰
4. è¯­æ°”ä¸“ä¸šå‹å¥½ï¼Œåƒå¤©æ°”é¢„æŠ¥å‘˜åœ¨è§£è¯´
5. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦æ ‡é¢˜

è¯·ç›´æ¥è¾“å‡ºæ€»ç»“å†…å®¹ï¼š''';
  }

  /// è§£æå¤©æ°”æé†’æ–‡æœ¬
  String? parseAlertText(String text) {
    // ä¿ç•™AIè¿”å›çš„åŸå§‹æ•°æ®ï¼Œåªå»æ‰é¦–å°¾ç©ºç™½
    final cleaned = text.trim();
    if (cleaned.isEmpty) return null;

    // ç§»é™¤å¯èƒ½çš„æ ‡ç‚¹ç¬¦å·
    return cleaned.replaceFirst(RegExp(r'^[ï¼š:]\s*'), '');
  }

  /// æ„å»ºæ™ºèƒ½ç©¿æ­é¡¾é—®Prompt
  String buildOutfitAdvisorPrompt({
    required String currentWeather,
    required String temperature,
    required String feelsLike,
    required String windPower,
    required String humidity,
    List<String>? hourlyWeather,
    String? minTemp,
    String? maxTemp,
  }) {
    final hourlyInfo = hourlyWeather != null && hourlyWeather.isNotEmpty
        ? 'æœªæ¥24å°æ—¶å¤©æ°”å˜åŒ–ï¼š${hourlyWeather.take(8).join('ã€')}'
        : '';

    return '''
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ—¶å°šç©¿æ­é¡¾é—®ï¼Œè¯·æ ¹æ®ä»¥ä¸‹å¤©æ°”ä¿¡æ¯ä¸ºç”¨æˆ·æä¾›ä»Šæ—¥ç©¿æ­å»ºè®®ï¼š

å½“å‰å¤©æ°”ä¿¡æ¯ï¼š
- å¤©æ°”çŠ¶å†µï¼š$currentWeather
- å®é™…æ¸©åº¦ï¼š$temperatureâ„ƒ
- ä½“æ„Ÿæ¸©åº¦ï¼š$feelsLikeâ„ƒ
- é£åŠ›ç­‰çº§ï¼š$windPower
- æ¹¿åº¦ï¼š$humidity%
- ä»Šæ—¥æ¸©åº¦èŒƒå›´ï¼š${minTemp ?? '--'}â„ƒ ~ ${maxTemp ?? '--'}â„ƒ
$hourlyInfo

è¯·æä¾›ä»¥ä¸‹ç©¿æ­å»ºè®®ï¼ˆä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œæ€»å­—æ•°æ§åˆ¶åœ¨200-250å­—ï¼‰ï¼š

**æ ¸å¿ƒæ¨è**
ç®€è¦è¯´æ˜ä»Šæ—¥ç©¿æ­æ ¸å¿ƒè¦ç‚¹ï¼ˆ30-40å­—ï¼‰

**ä¸Šè£…å»ºè®®**
å…·ä½“çš„ä¸Šè£…æ­é…ï¼ˆå¤–å¥—ã€è¡¬è¡«ã€Tæ¤ç­‰ï¼‰ï¼ŒåŒ…å«æè´¨å’Œæ¬¾å¼ï¼ˆ40-50å­—ï¼‰

**ä¸‹è£…å»ºè®®**
å…·ä½“çš„ä¸‹è£…æ­é…ï¼ˆè£¤è£…ã€è£™è£…ç­‰ï¼‰ï¼ŒåŒ…å«æè´¨å’Œæ¬¾å¼ï¼ˆ30-40å­—ï¼‰

**é…é¥°æ¨è**
æ ¹æ®å¤©æ°”æ¨èé…é¥°ï¼ˆå¸½å­ã€å›´å·¾ã€å¢¨é•œã€é›¨å…·ç­‰ï¼‰ï¼ˆ30-40å­—ï¼‰

**è‰²å½©æ­é…**
æ¨èé€‚åˆä»Šæ—¥å¤©æ°”çš„è‰²å½©æ­é…æ–¹æ¡ˆï¼ˆ20-30å­—ï¼‰

**ç‰¹åˆ«æç¤º**
æ ¹æ®å¤©æ°”å˜åŒ–ç»™å‡ºçš„ç‰¹åˆ«æ³¨æ„äº‹é¡¹ï¼ˆ30-40å­—ï¼‰

è¦æ±‚ï¼š
1. å»ºè®®è¦å…·ä½“ã€å®ç”¨ã€æ˜“æ“ä½œ
2. è€ƒè™‘æ¸©åº¦å˜åŒ–å’Œä½“æ„Ÿå·®å¼‚
3. é›¨å¤©å¿…é¡»æé†’é›¨å…·
4. å¤§é£å¤©æé†’é˜²é£
5. æ¸©å·®å¤§æé†’åˆ†å±‚ç©¿æ­
6. è¯­è¨€äº²åˆ‡ã€ä¸“ä¸š
7. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ é¢å¤–çš„ç©ºè¡Œ
''';
  }

  /// æ„å»ºå¥åº·ç®¡å®¶Prompt
  String buildHealthAdvisorPrompt({
    required String currentWeather,
    required String temperature,
    required String feelsLike,
    required String aqi,
    required String aqiLevel,
    required String humidity,
    required String windPower,
    String userGroup = 'general', // general, elderly, children, allergy
  }) {
    String userGroupDesc = '';
    switch (userGroup) {
      case 'elderly':
        userGroupDesc = 'è€å¹´äººç¾¤ä½“ï¼ˆéœ€è¦ç‰¹åˆ«å…³æ³¨å¿ƒè¡€ç®¡ã€å‘¼å¸ç³»ç»Ÿã€å…³èŠ‚ç­‰ï¼‰';
        break;
      case 'children':
        userGroupDesc = 'å„¿ç«¥ç¾¤ä½“ï¼ˆéœ€è¦ç‰¹åˆ«å…³æ³¨å…ç–«åŠ›ã€çš®è‚¤ã€å‘¼å¸é“ç­‰ï¼‰';
        break;
      case 'allergy':
        userGroupDesc = 'è¿‡æ•ä½“è´¨äººç¾¤ï¼ˆéœ€è¦ç‰¹åˆ«å…³æ³¨è¿‡æ•æºã€ç©ºæ°”è´¨é‡ã€èŠ±ç²‰ç­‰ï¼‰';
        break;
      default:
        userGroupDesc = 'ä¸€èˆ¬äººç¾¤';
    }

    return '''
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¥åº·ç®¡ç†é¡¾é—®ï¼Œè¯·æ ¹æ®ä»¥ä¸‹å¤©æ°”å’Œç©ºæ°”è´¨é‡ä¿¡æ¯ï¼Œä¸º$userGroupDescæä¾›ä»Šæ—¥å¥åº·å»ºè®®ï¼š

å¤©æ°”ä¿¡æ¯ï¼š
- å¤©æ°”çŠ¶å†µï¼š$currentWeather
- å®é™…æ¸©åº¦ï¼š$temperatureâ„ƒ
- ä½“æ„Ÿæ¸©åº¦ï¼š$feelsLikeâ„ƒ
- æ¹¿åº¦ï¼š$humidity%
- é£åŠ›ï¼š$windPower
- ç©ºæ°”è´¨é‡ï¼š$aqiLevelï¼ˆAQI $aqiï¼‰

è¯·æä¾›ä»¥ä¸‹å¥åº·å»ºè®®ï¼ˆä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œæ€»å­—æ•°æ§åˆ¶åœ¨180-220å­—ï¼‰ï¼š

**å¥åº·é£é™©æç¤º**
æ ¹æ®å¤©æ°”å’Œç©ºæ°”è´¨é‡ï¼ŒæŒ‡å‡ºä»Šæ—¥ä¸»è¦å¥åº·é£é™©ï¼ˆ30-40å­—ï¼‰

**å‡ºè¡Œå»ºè®®**
æ˜¯å¦é€‚åˆæˆ·å¤–æ´»åŠ¨ã€è¿åŠ¨ï¼Œæœ€ä½³å‡ºè¡Œæ—¶æ®µï¼ˆ30-40å­—ï¼‰

**é¥®é£Ÿå»ºè®®**
æ ¹æ®å¤©æ°”æ¨èé€‚åˆçš„é¥®é£Ÿå’Œè¡¥æ°´æ–¹æ¡ˆï¼ˆ30-40å­—ï¼‰

**é˜²æŠ¤æªæ–½**
å¿…è¦çš„å¥åº·é˜²æŠ¤æªæ–½ï¼ˆå£ç½©ã€é˜²æ™’ã€ä¿æš–ç­‰ï¼‰ï¼ˆ30-40å­—ï¼‰

**ç‰¹æ®Šæé†’**
é’ˆå¯¹${userGroupDesc.split('ï¼ˆ')[0]}çš„ç‰¹åˆ«æ³¨æ„äº‹é¡¹ï¼ˆ40-50å­—ï¼‰

è¦æ±‚ï¼š
1. é’ˆå¯¹ç›®æ ‡äººç¾¤çš„ç‰¹ç‚¹ç»™å‡ºä¸“ä¸šå»ºè®®
2. è€å¹´äººé‡ç‚¹å…³æ³¨å¿ƒè¡€ç®¡å’Œå…³èŠ‚
3. å„¿ç«¥é‡ç‚¹å…³æ³¨å…ç–«åŠ›å’Œå‘¼å¸é“
4. è¿‡æ•ä½“è´¨é‡ç‚¹å…³æ³¨è¿‡æ•æºå’Œç©ºæ°”è´¨é‡
5. AQI>100å¿…é¡»æé†’å‡å°‘æˆ·å¤–æ´»åŠ¨
6. æ¸©å·®>10â„ƒæé†’é¢„é˜²æ„Ÿå†’
7. è¯­è¨€æ¸©æš–ã€ä¸“ä¸šã€æ˜“æ‡‚
8. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡º
''';
  }

  /// æ„å»ºå¼‚å¸¸å¤©æ°”é¢„è­¦Prompt
  String buildExtremeWeatherAlertPrompt({
    required String currentWeather,
    required String temperature,
    required String windPower,
    required String visibility,
    String? alerts, // å®˜æ–¹æ°”è±¡é¢„è­¦
    List<String>? hourlyWeather,
  }) {
    final alertInfo = alerts != null && alerts.isNotEmpty
        ? 'å®˜æ–¹é¢„è­¦ï¼š$alerts'
        : 'æš‚æ— å®˜æ–¹é¢„è­¦';

    final hourlyInfo = hourlyWeather != null && hourlyWeather.isNotEmpty
        ? 'æœªæ¥24å°æ—¶ï¼š${hourlyWeather.take(6).join('â†’')}'
        : '';

    return '''
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ°”è±¡å®‰å…¨é¡¾é—®ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯åˆ†ææ˜¯å¦å­˜åœ¨å¼‚å¸¸å¤©æ°”ï¼Œå¹¶ç»™å‡ºå®‰å…¨æé†’ï¼š

å¤©æ°”ä¿¡æ¯ï¼š
- å½“å‰å¤©æ°”ï¼š$currentWeather
- æ¸©åº¦ï¼š$temperatureâ„ƒ
- é£åŠ›ï¼š$windPower
- èƒ½è§åº¦ï¼š$visibility km
- $alertInfo
$hourlyInfo

è¯·åˆ†æå¹¶æä¾›é¢„è­¦å»ºè®®ï¼ˆä¸¥æ ¼æŒ‰ç…§æ ¼å¼ï¼Œæ€»å­—æ•°æ§åˆ¶åœ¨150-200å­—ï¼‰ï¼š

**å¤©æ°”å¼‚å¸¸åˆ¤æ–­**
æ˜¯å¦å­˜åœ¨å¼‚å¸¸å¤©æ°”ï¼Ÿï¼ˆæš´é›¨ã€æš´é›ªã€å¼ºé£ã€é«˜æ¸©ã€ä½æ¸©ã€æµ“é›¾ã€é›·æš´ç­‰ï¼‰ï¼ˆ20-30å­—ï¼‰

**é£é™©ç­‰çº§**
è¯„ä¼°é£é™©ç­‰çº§ï¼šé«˜å±/ä¸­å±/ä½å±/æ­£å¸¸ï¼ˆ10å­—ä»¥å†…ï¼‰

**ä¸»è¦é£é™©**
åˆ—å‡ºä¸»è¦çš„å®‰å…¨é£é™©ç‚¹ï¼ˆ30-40å­—ï¼‰

**å®‰å…¨å»ºè®®**
å…·ä½“çš„å®‰å…¨é˜²èŒƒæªæ–½å’Œè¡ŒåŠ¨å»ºè®®ï¼ˆ50-70å­—ï¼‰

**ç´§æ€¥æé†’**
å¦‚æœæ˜¯é«˜å±å¤©æ°”ï¼Œç»™å‡ºç´§æ€¥æé†’ï¼ˆæœ‰åˆ™30-40å­—ï¼Œæ— åˆ™çœç•¥æ­¤é¡¹ï¼‰

åˆ¤æ–­æ ‡å‡†ï¼š
1. æš´é›¨ã€æš´é›ªã€é›·æš´ â†’ é«˜å±
2. å¤§é›¨ã€å¤§é›ªã€7çº§ä»¥ä¸Šå¤§é£ â†’ ä¸­å±
3. ä¸­é›¨ã€ä¸­é›ªã€æµ“é›¾ã€é«˜æ¸©>38â„ƒã€ä½æ¸©<-10â„ƒ â†’ ä½å±
4. å…¶ä»–æƒ…å†µ â†’ æ­£å¸¸
5. æœ‰å®˜æ–¹é¢„è­¦å¿…é¡»é‡ç‚¹æç¤º
6. ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡º
''';
  }

  /// æ„å»ºä¼˜åŒ–çš„é€šå‹¤å»ºè®®Promptï¼ˆæ”¹è¿›ç‰ˆï¼‰
  String buildOptimizedCommutePrompt({
    required String weatherType,
    required String temperature,
    required String windPower,
    required String airQuality,
    required String timeSlot,
    required List<String> futureWeather,
  }) {
    final futureWeatherStr = futureWeather.isEmpty
        ? 'æ— é¢„æŠ¥æ•°æ®'
        : futureWeather.join('ã€');

    final greeting = timeSlot == 'morning' ? 'æ—©å®‰' : 'æ™šå®‰';
    final timeLabel = timeSlot == 'morning' ? 'æ—©é«˜å³°' : 'æ™šé«˜å³°';

    return '''ã€è§’è‰²å®šä¹‰ã€‘
ä½ æ˜¯ã€Œé€šå‹¤å¤©æ°”ç®¡å®¶ã€â€”â€”ä¸€ä½ä¸“æ³¨äºç”¨å¤©æ°”æ•°æ®å®ˆæŠ¤ä¸Šä¸‹ç­å®‰å…¨ã€èˆ’é€‚ã€æ•ˆç‡çš„ç§äººåŠ©ç†ã€‚

ã€å½“å‰æ—¶æ®µã€‘$timeLabel é€šå‹¤

ã€å¤©æ°”æ•°æ®ã€‘
- å¤©æ°”ç°è±¡ï¼š$weatherType
- æ°”æ¸©ï¼š$temperatureâ„ƒ
- é£åŠ›ï¼š$windPower
- ç©ºæ°”è´¨é‡ï¼š$airQuality
- æœªæ¥è¶‹åŠ¿ï¼š$futureWeatherStr

ã€ä¸¥æ ¼è¾“å‡ºæ ¼å¼ã€‘
âš ï¸ è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ æˆ–å‡å°‘ä»»ä½•ç©ºè¡Œï¼š

ç¬¬1è¡Œï¼š${greeting == 'æ—©å®‰' ? 'ğŸŒ' : 'ğŸŒ™'} ${greeting}ï¼ä»Šå¤©$timeLabel é€šå‹¤å¦‚ä¸‹â€”â€”
ç¬¬2è¡Œï¼šç©ºè¡Œ
ç¬¬3è¡Œå¼€å§‹ï¼šåˆ†æ®µæ¸…å•ï¼ˆæ¯è¡Œä¸€ä¸ªå»ºè®®ï¼Œæ ¹æ®å¤©æ°”é€‰æ‹©2-5é¡¹ï¼Œè¡Œä¸è¡Œä¹‹é—´ä¸åŠ ç©ºè¡Œï¼‰
  - ğŸŒ‚ é˜²é›¨ï¼š[å†…å®¹]ï¼ˆâš ï¸åªæœ‰ä¸‹é›¨æ—¶æ‰å»ºè®®å¸¦ä¼ï¼Œé›¾/éœ¾/é˜´å¤©ä¸å»ºè®®ï¼‰
  - ğŸ‘” ç€è£…ï¼š[å…·ä½“ç€è£…]ï¼ˆå¿…é¡»å…·ä½“ï¼Œå¦‚ï¼šé•¿è¢–è¡¬è¡«+è–„å¤–å¥—ã€ç¾½ç»’æœ+ä¿æš–å†…è¡£ï¼‰
  - ğŸ‘Ÿ é‹å±¥ï¼š[å†…å®¹]
  - â˜€ï¸ é˜²æ™’/é˜²å¯’ï¼š[å†…å®¹]
  - ğŸ«§ ç©ºæ°”ï¼š[å†…å®¹]
  - ğŸš¦ äº¤é€šå®‰å…¨ï¼š[å†…å®¹]
æ¸…å•æœ€åä¸€è¡Œåï¼šç©ºè¡Œ
ä¸‹ä¸€è¡Œï¼šğŸš‡ äº¤é€šæŒ‡æ•°ï¼š
ä¹‹åæ¯è¡Œï¼šä¸€ä¸ªäº¤é€šå·¥å…·åŠå…¶æ˜Ÿçº§ï¼ˆåœ°é“â­â­â­â­â­ï¼‰
äº¤é€šæŒ‡æ•°æœ€åä¸€è¡Œåï¼šç©ºè¡Œ
æœ€åä¸€è¡Œï¼šğŸ’¡ [å½©è›‹å†…å®¹]

ã€å†…å®¹è¦æ±‚ã€‘
- æ¯æ¡å»ºè®®â‰¤20å­—
- äº²åˆ‡ã€å£è¯­åŒ–
- å…ˆç»“è®ºå†ç†ç”±
- æ€»å­—æ•°150-200å­—

ã€ä¸¥æ ¼æ ¼å¼ç¤ºä¾‹ã€‘ï¼ˆè¯·å®Œå…¨æŒ‰ç…§æ­¤æ ¼å¼ï¼ŒåŒ…æ‹¬ç©ºè¡Œä½ç½®ï¼‰
ğŸŒ æ—©å®‰ï¼ä»Šå¤©æ—©é«˜å³°é€šå‹¤å¦‚ä¸‹â€”â€”

ğŸŒ‚ é˜²é›¨ï¼šé™æ°´æ¦‚ç‡ä½ï¼Œæ”¾å¿ƒçœä¼ã€‚
ğŸ‘” ç€è£…ï¼šè–„é•¿è¢–+é˜²æ™’è¡«ï¼Œèˆ’é€‚é€æ°”ã€‚
ğŸ‘Ÿ é‹å±¥ï¼šè·¯é¢å¹²ç‡¥ï¼Œå¸¸è§„è¿åŠ¨é‹ã€‚
â˜€ï¸ é˜²æ™’ï¼šç´«å¤–çº¿å¼ºï¼Œéœ²è‚¤æ¶‚SPF30+ã€‚
ğŸ«§ ç©ºæ°”ï¼šAQIä¼˜ï¼Œç•…å¿«å‘¼å¸ã€‚
ğŸš‡ äº¤é€šæŒ‡æ•°ï¼š
åœ°é“ â­â­â­â­â­
å…¬äº¤ â­â­â­â­
éª‘è¡Œ â­â­â­
è‡ªé©¾ â­â­

ğŸ’¡ ä»Šå¤©æ˜¯ä¸ªå¥½å¤©æ°”ï¼Œä¿æŒå¥½å¿ƒæƒ…ï¼

âš ï¸ ä¸¥æ ¼è¦æ±‚ï¼š
1. é—®å€™è¯­åå¿…é¡»æœ‰1ä¸ªç©ºè¡Œ
2. æ¸…å•é¡¹ä¹‹é—´ä¸åŠ ç©ºè¡Œ
3. äº¤é€šæŒ‡æ•°æ ‡é¢˜å•ç‹¬ä¸€è¡Œ
4. æ¯ä¸ªäº¤é€šå·¥å…·å•ç‹¬ä¸€è¡Œ
5. äº¤é€šæŒ‡æ•°å’Œå½©è›‹ä¹‹é—´å¿…é¡»æœ‰1ä¸ªç©ºè¡Œ
6. ä¸è¦åœ¨å¼€å¤´æˆ–ç»“å°¾æ·»åŠ é¢å¤–ç©ºè¡Œ

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºï¼Œç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å…¶ä»–è¯´æ˜ã€‚''';
  }
}
